{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/computer/Documents/GitHub/MasseurMatch-usa/proxy.ts"],"sourcesContent":["// proxy.ts - SEO & Security Control + Auth Protection\r\n// NOTE: Next.js treats this file as the sole middleware entrypoint. Do not add\r\n// middleware.ts alongside this file, or Next will fail with a duplicate\r\n// middleware/proxy error.\r\nimport { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport { createServerClient, type CookieOptions } from \"@supabase/ssr\";\r\n\r\n// ====================================\r\n// BLOCKED COUNTRIES (ISO 3166-1 alpha-2)\r\n// ====================================\r\n// Reasons: Anti-LGBTQ+ laws, US sanctions, high fraud/trafficking risk\r\nconst BLOCKED_COUNTRIES = new Set([\r\n  // Severe anti-LGBTQ+ laws (death penalty or life imprisonment)\r\n  \"IR\", // Iran\r\n  \"SA\", // Saudi Arabia\r\n  \"AF\", // Afghanistan\r\n  \"BN\", // Brunei\r\n  \"NG\", // Nigeria (northern states)\r\n  \"MR\", // Mauritania\r\n  \"YE\", // Yemen\r\n  \"SO\", // Somalia\r\n  \"SD\", // Sudan\r\n  \"UG\", // Uganda\r\n  // US Sanctions\r\n  \"RU\", // Russia\r\n  \"KP\", // North Korea\r\n  \"CU\", // Cuba\r\n  \"SY\", // Syria\r\n  // High trafficking/fraud risk\r\n  \"MM\", // Myanmar\r\n]);\r\n\r\n// ====================================\r\n// PROTECTED ROUTES (Require Authentication)\r\n// ====================================\r\nconst PROTECTED_ROUTES = [\"/dashboard\", \"/edit-profile\"];\r\n\r\nconst NOINDEX_ROUTES = [\r\n  \"/login\",\r\n  \"/join/form\",\r\n  \"/recuperar\",\r\n  \"/dashboard\",\r\n  \"/edit-profile\",\r\n  \"/pending\",\r\n  \"/checkout\",\r\n  \"/admin\",\r\n];\r\n\r\nconst LEGAL_REDIRECTS: Record<string, string> = {\r\n  \"/terms\": \"/legal/terms\",\r\n  \"/privacy-policy\": \"/legal/privacy-policy\",\r\n  \"/community-guidelines\": \"/legal/community-guidelines\",\r\n  \"/cookie-policy\": \"/legal/cookie-policy\",\r\n  \"/professional-standards\": \"/legal/professional-standards\",\r\n  \"/anti-trafficking\": \"/legal/anti-trafficking\",\r\n};\r\n\r\nfunction normalizePath(pathname: string) {\r\n  if (pathname.length > 1 && pathname.endsWith(\"/\")) return pathname.slice(0, -1);\r\n  return pathname;\r\n}\r\n\r\nexport async function proxy(req: NextRequest) {\r\n  const pathname = normalizePath(req.nextUrl.pathname);\r\n  // Shared response instance so that any cookies set during auth are preserved\r\n  // for the rest of the middleware chain.\r\n  let res = NextResponse.next({\r\n    request: {\r\n      headers: req.headers,\r\n    },\r\n  });\r\n\r\n  // ====================================\r\n  // AUTH PROTECTION (Protected Routes)\r\n  // ====================================\r\n  const isProtectedRoute = PROTECTED_ROUTES.some(\r\n    (route) => pathname === route || pathname.startsWith(`${route}/`)\r\n  );\r\n\r\n  if (isProtectedRoute) {\r\n    const supabase = createServerClient(\r\n      supabaseUrl,\r\n      supabaseAnonKey,\r\n      {\r\n        cookies: {\r\n          get(name: string) {\r\n            return req.cookies.get(name)?.value;\r\n          },\r\n          set(name: string, value: string, options: CookieOptions) {\r\n            res.cookies.set({\r\n              name,\r\n              value,\r\n              ...options,\r\n            });\r\n          },\r\n          remove(name: string, options: CookieOptions) {\r\n            res.cookies.set({\r\n              name,\r\n              value: \"\",\r\n              ...options,\r\n            });\r\n          },\r\n        },\r\n      }\r\n    );\r\n\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n\r\n    if (!session) {\r\n      const redirectUrl = req.nextUrl.clone();\r\n      redirectUrl.pathname = \"/login\";\r\n      redirectUrl.searchParams.set(\r\n        \"redirectTo\",\r\n        `${pathname}${req.nextUrl.search}`\r\n      );\r\n      return NextResponse.redirect(redirectUrl);\r\n    }\r\n  }\r\n\r\n  // ====================================\r\n  // GEO-BLOCKING (Country Restriction)\r\n  // ====================================\r\n  // Skip geo-blocking for the blocked page itself to avoid redirect loop\r\n  if (pathname !== \"/blocked\") {\r\n    // Vercel automatically provides country code via x-vercel-ip-country header.\r\n    // In some environments `req.geo` is present but not typed, so we cast safely.\r\n    const geoCountry = (req as NextRequest & { geo?: { country?: string } }).geo\r\n      ?.country;\r\n    const country = req.headers.get(\"x-vercel-ip-country\") || geoCountry;\r\n\r\n    if (country && BLOCKED_COUNTRIES.has(country)) {\r\n      const blockedUrl = req.nextUrl.clone();\r\n      blockedUrl.pathname = \"/blocked\";\r\n      return NextResponse.rewrite(blockedUrl);\r\n    }\r\n  }\r\n\r\n  // ====================================\r\n  // BYPASS WAITLIST (Vercel rewrites)\r\n  // ====================================\r\n  // IMPORTANT: This must be before any redirects/headers logic\r\n  if (pathname === \"/waitlist\" || pathname.startsWith(\"/waitlist/\")) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // ====================================\r\n  // 301 REDIRECTS - Legal Pages Migration\r\n  // ====================================\r\n  const legalTarget = LEGAL_REDIRECTS[pathname];\r\n  if (legalTarget) {\r\n    const newUrl = req.nextUrl.clone();\r\n    newUrl.pathname = legalTarget;\r\n    return NextResponse.redirect(newUrl, 301);\r\n  }\r\n\r\n  // ====================================\r\n  // FORCE WWW (SEO Best Practice) - proxy-safe\r\n  // ====================================\r\n  const forwardedHost = req.headers.get(\"x-forwarded-host\");\r\n  const host = forwardedHost ?? req.headers.get(\"host\");\r\n\r\n  if (\r\n    host &&\r\n    !host.startsWith(\"www.\") &&\r\n    !host.includes(\"localhost\") &&\r\n    !host.includes(\"vercel.app\")\r\n  ) {\r\n    const newUrl = req.nextUrl.clone();\r\n    newUrl.host = `www.${host}`;\r\n    return NextResponse.redirect(newUrl, 301);\r\n  }\r\n\r\n  // ====================================\r\n  // RESPONSE (headers)\r\n  // ====================================\r\n  // ====================================\r\n  // NOINDEX ROUTES (Private/User Areas)\r\n  // ====================================\r\n  if (NOINDEX_ROUTES.some((route) => pathname.startsWith(route))) {\r\n    res.headers.set(\"X-Robots-Tag\", \"noindex, nofollow\");\r\n  }\r\n\r\n  // ====================================\r\n  // SECURITY HEADERS\r\n  // ====================================\r\n  // Prevent clickjacking\r\n  res.headers.set(\"X-Frame-Options\", \"DENY\");\r\n\r\n  // Prevent MIME type sniffing\r\n  res.headers.set(\"X-Content-Type-Options\", \"nosniff\");\r\n\r\n  // Referrer Policy\r\n  res.headers.set(\"Referrer-Policy\", \"strict-origin-when-cross-origin\");\r\n\r\n  // HSTS (only meaningful on HTTPS; safe to set in production)\r\n  res.headers.set(\r\n    \"Strict-Transport-Security\",\r\n    \"max-age=31536000; includeSubDomains; preload\"\r\n  );\r\n\r\n  // Permissions Policy (hardening)\r\n  res.headers.set(\r\n    \"Permissions-Policy\",\r\n    \"camera=(), microphone=(), geolocation=(), payment=()\"\r\n  );\r\n\r\n  // Basic CSP (adjust if you use external scripts like Stripe/GTM etc.)\r\n  res.headers.set(\r\n    \"Content-Security-Policy\",\r\n    [\r\n      \"default-src 'self'\",\r\n      \"base-uri 'self'\",\r\n      \"object-src 'none'\",\r\n      \"frame-ancestors 'none'\",\r\n      \"img-src 'self' data: https:\",\r\n      \"font-src 'self' data: https:\",\r\n      \"style-src 'self' 'unsafe-inline'\",\r\n      \"script-src 'self' 'unsafe-inline' 'unsafe-eval'\",\r\n      \"connect-src 'self' https: wss:\",\r\n      \"upgrade-insecure-requests\",\r\n    ].join(\"; \")\r\n  );\r\n\r\n  return res;\r\n}\r\n\r\n// ====================================\r\n// MATCHER - Routes to apply middleware\r\n// ====================================\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization)\r\n     * - favicon.ico (favicon)\r\n     * - robots.txt / sitemap.xml (SEO files)\r\n     * - common static assets\r\n     */\r\n    \"/((?!_next/static|_next/image|favicon.ico|robots.txt|sitemap.xml|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico|css|js|map)$).*)\",\r\n  ],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}